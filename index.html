<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AppLisS ‚Äî Clientes, Pedidos y Abonos (Google Sheets)</title>
  <meta name="description" content="AppLisS: control de clientes, pedidos y abonos con Google Sheets (SheetDB) desde GitHub Pages.">
  <style>
    :root{
      --bg:#f8fafc; --text:#0f172a; --muted:#64748b; --card:#ffffff;
      --border:#e2e8f0; --accent:#0f172a; --ok:#22c55e; --warn:#f97316; --info:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:var(--bg);color:var(--text)}
    header{padding:18px 16px;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2}
    h1{margin:0;font-size:1.35rem}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab-btn{border:1px solid var(--border);background:#fff;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    .tab-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
    section.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:14px 0}
    .grid{display:grid;gap:12px}
    @media(min-width:800px){.grid-2{grid-template-columns:1fr 1fr}}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:80px;resize:vertical}
    .btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.secondary{background:var(--info)}
    .btn.ok{background:var(--ok)}
    .btn.warn{background:var(--warn)}
    .list{display:grid;gap:10px;margin-top:10px}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#f1f5f9}
    .muted{color:var(--muted);font-size:.92rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .kpis{display:grid;gap:12px}
    @media(min-width:800px){.kpis{grid-template-columns:repeat(4,1fr)}}
    .kpi{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
    .kpi h3{margin:0 0 6px 0;font-size:.95rem;color:var(--muted)}
    .kpi .val{font-size:1.25rem;font-weight:700}
    small.code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;color:#e5e7eb;padding:2px 6px;border-radius:6px}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:.8rem}
    .sep{height:1px;background:var(--border);margin:10px 0}
  </style>
</head>
<body>
  <header>
    <h1>üìã AppLisS ‚Äî Liss Variedades (Google Sheets)</h1>
    <div class="muted">Base compartida v√≠a <strong>SheetDB</strong> ‚Äî todos ven los mismos datos</div>
  </header>

  <div class="container">

    <!-- TABS -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
      <button class="tab-btn" data-tab="clientes">Clientes</button>
      <button class="tab-btn" data-tab="pedidos">Pedidos</button>
      <button class="tab-btn" data-tab="pagos">Pagos / Abonos</button>
      <span class="muted" style="margin-left:auto">Endpoint: <small class="code" id="endpointView"></small></span>
    </div>

    <!-- DASHBOARD -->
    <section class="card tab tab-dashboard" style="display:block">
      <h2>üìä Resumen general</h2>
      <div class="kpis">
        <div class="kpi"><h3>Clientes</h3><div class="val" id="kpiClientes">0</div></div>
        <div class="kpi"><h3>Pedidos</h3><div class="val" id="kpiPedidos">0</div></div>
        <div class="kpi"><h3>Total vendido</h3><div class="val" id="kpiVendido">RD$ 0</div></div>
        <div class="kpi"><h3>Total cobrado</h3><div class="val" id="kpiCobrado">RD$ 0</div></div>
      </div>
      <div class="sep"></div>
      <div class="muted">Tip: si alg√∫n valor no cuadra, recarga con el bot√≥n ‚ûú <button class="btn secondary" id="btnRecargar">Recargar datos</button></div>
    </section>

    <!-- CLIENTES -->
    <section class="card tab tab-clientes" style="display:none">
      <h2>üë§ Clientes</h2>
      <div class="grid grid-2">
        <div>
          <h3>‚ûï Registrar cliente</h3>
          <div class="grid">
            <input id="cNombre" placeholder="Nombre completo">
            <input id="cTelefono" placeholder="Tel√©fono">
            <input id="cEmail" placeholder="Email (opcional)">
            <textarea id="cNotas" placeholder="Notas"></textarea>
            <button class="btn" id="btnAddCliente">Guardar cliente</button>
          </div>
          <p class="muted">Se guardar√° una fila <span class="pill">tipo=cliente</span> en la hoja.</p>
        </div>
        <div>
          <h3>üìã Listado</h3>
          <div id="listaClientes" class="list"></div>
        </div>
      </div>
    </section>

    <!-- PEDIDOS -->
    <section class="card tab tab-pedidos" style="display:none">
      <h2>üì¶ Pedidos</h2>
      <div class="grid grid-2">
        <div>
          <h3>‚ûï Registrar pedido</h3>
          <div class="grid">
            <select id="pCliente"></select>
            <input id="pArticulo" placeholder="Art√≠culo">
            <div class="row">
              <input id="pValor" type="number" placeholder="Valor (RD$)" style="flex:1">
              <input id="pPorc" type="number" placeholder="% (ganancia)" style="flex:1">
              <input id="pLibra" type="number" placeholder="Libra (RD$)" style="flex:1">
            </div>
            <div class="row">
              <input id="pTracking" placeholder="Tracking" style="flex:1">
              <select id="pEstado" style="flex:1">
                <option value="pendiente">Pendiente</option>
                <option value="enviado">Enviado</option>
                <option value="entregado">Entregado</option>
                <option value="cancelado">Cancelado</option>
              </select>
            </div>
            <button class="btn" id="btnAddPedido">Guardar pedido</button>
          </div>
          <p class="muted">Se guardar√° una fila <span class="pill">tipo=pedido</span> vinculada al cliente elegido.</p>
        </div>
        <div>
          <h3>üìã Listado</h3>
          <div id="listaPedidos" class="list"></div>
        </div>
      </div>
    </section>

    <!-- PAGOS -->
    <section class="card tab tab-pagos" style="display:none">
      <h2>üíµ Pagos / Abonos</h2>
      <div class="grid grid-2">
        <div>
          <h3>‚ûï Registrar abono</h3>
          <div class="grid">
            <select id="payCliente"></select>
            <select id="payPedido"></select>
            <input id="payMonto" type="number" placeholder="Monto (RD$)">
            <button class="btn ok" id="btnAddPago">Guardar abono</button>
          </div>
          <p class="muted">Se guardar√° una fila <span class="pill">tipo=pago</span> con columna <span class="pill">abono</span>.</p>
        </div>
        <div>
          <h3>üìú Historial reciente</h3>
          <div id="listaPagos" class="list"></div>
        </div>
      </div>
    </section>

  </div>

  <script>
    // ========= CONFIG =========
    const API_URL = "https://sheetdb.io/api/v1/avsi1ki6gcrlr"; // <- tu endpoint
    document.getElementById("endpointView").textContent = API_URL;

    // ========= UTIL =========
    const $ = sel => document.querySelector(sel);
    const byId = id => document.getElementById(id);
    const uid = (p) => `${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,8)}`;
    const fmtMoney = n => `RD$ ${Number(n||0).toLocaleString("es-DO",{maximumFractionDigits:2})}`;

    // ========= STATE =========
    let RAW = [];              // todas las filas crudas de la hoja
    let CLIENTES = [];         // solo filas tipo=cliente
    let PEDIDOS = [];          // solo filas tipo=pedido
    let PAGOS = [];            // solo filas tipo=pago

    // ========= TABS =========
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab").forEach(t=>t.style.display="none");
        document.querySelector(`.tab-${tab}`).style.display="block";
      });
    });

    byId("btnRecargar").onclick = () => loadAll(true);

    // ========= API =========
    async function apiList(){
      const res = await fetch(API_URL);
      if(!res.ok) throw new Error("No se pudo leer la hoja");
      return res.json();
    }
    async function apiInsert(obj){
      const res = await fetch(API_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ data:[obj] })
      });
      if(!res.ok) throw new Error("No se pudo insertar");
      return res.json();
    }

    // ========= LOAD & BUILD =========
    async function loadAll(showAlert){
      const data = await apiList();
      RAW = Array.isArray(data) ? data : [];
      CLIENTES = RAW.filter(r => (r.tipo||"").toLowerCase()==="cliente");
      PEDIDOS  = RAW.filter(r => (r.tipo||"").toLowerCase()==="pedido");
      PAGOS    = RAW.filter(r => (r.tipo||"").toLowerCase()==="pago");

      fillSelects();
      renderClientes();
      renderPedidos();
      renderPagos();
      renderKPIs();
      if(showAlert) alert("‚úÖ Datos recargados");
    }

    function fillSelects(){
      // Clientes en select de pedidos y pagos
      const pCliente = byId("pCliente");
      const payCliente = byId("payCliente");
      pCliente.innerHTML = `<option value="">‚Äî Elegir cliente ‚Äî</option>`;
      payCliente.innerHTML = `<option value="">‚Äî Elegir cliente ‚Äî</option>`;
      CLIENTES.forEach(c=>{
        const opt = `<option value="${c.id}">${c.nombre||"(sin nombre)"} ‚Äî ${c.telefono||""}</option>`;
        pCliente.insertAdjacentHTML("beforeend", opt);
        payCliente.insertAdjacentHTML("beforeend", opt);
      });

      // cuando elija cliente para pagos, cargar pedidos
      payCliente.onchange = ()=>{
        const cid = payCliente.value;
        fillPedidosByCliente(cid);
      };
      // inicial
      fillPedidosByCliente(payCliente.value);
    }

    function fillPedidosByCliente(clienteId){
      const payPedido = byId("payPedido");
      payPedido.innerHTML = `<option value="">‚Äî Elegir pedido ‚Äî</option>`;
      const lista = PEDIDOS.filter(p => (p.cliente_id||"")===clienteId);
      lista.forEach(p=>{
        const label = `${p.articulo||"(Art.)"} ‚Äî ${fmtMoney(calcTotalPedido(p))}`;
        payPedido.insertAdjacentHTML("beforeend", `<option value="${p.id}">${label}</option>`);
      });
    }

    // ========= RENDERS =========
    function renderKPIs(){
      const totalClientes = CLIENTES.length;
      const totalPedidos = PEDIDOS.length;
      const vendido = PEDIDOS.reduce((acc,p)=>acc+calcTotalPedido(p),0);
      const cobrado = PAGOS.reduce((acc,pg)=>acc+Number(pg.abono||0),0);

      byId("kpiClientes").textContent = totalClientes;
      byId("kpiPedidos").textContent = totalPedidos;
      byId("kpiVendido").textContent = fmtMoney(vendido);
      byId("kpiCobrado").textContent = fmtMoney(cobrado);
    }

    function renderClientes(){
      const box = byId("listaClientes");
      box.innerHTML = "";
      CLIENTES.forEach(c=>{
        const pedidos = PEDIDOS.filter(p=>p.cliente_id===c.id);
        const totalVendido = pedidos.reduce((acc,p)=>acc+calcTotalPedido(p),0);
        const pagos = PAGOS.filter(pg=>pg.cliente_id===c.id);
        const totalAbonos = pagos.reduce((acc,pg)=>acc+Number(pg.abono||0),0);
        const pendiente = totalVendido - totalAbonos;

        const html = `
          <div class="item">
            <div class="row" style="justify-content:space-between">
              <div>
                <strong>${c.nombre||"(Sin nombre)"}</strong>
                <div class="muted">üìû ${c.telefono||"-"} ‚Ä¢ ${c.email||""}</div>
              </div>
              <div class="pill">${pedidos.length} pedido(s)</div>
            </div>
            <div class="row" style="gap:20px;margin-top:6px">
              <div><strong>Total:</strong> ${fmtMoney(totalVendido)}</div>
              <div><strong>Cobrado:</strong> ${fmtMoney(totalAbonos)}</div>
              <div><strong>Pendiente:</strong> ${fmtMoney(pendiente)}</div>
            </div>
            ${c.notas?`<div class="muted" style="margin-top:6px">üìù ${c.notas}</div>`:""}
          </div>
        `;
        box.insertAdjacentHTML("beforeend", html);
      });
    }

    function renderPedidos(){
      const box = byId("listaPedidos");
      box.innerHTML = "";
      // ordenar por fecha desc (si existe)
      const list = [...PEDIDOS].sort((a,b)=> (new Date(b.fecha||0)) - (new Date(a.fecha||0)));
      list.forEach(p=>{
        const cli = CLIENTES.find(c=>c.id===p.cliente_id);
        const pagos = PAGOS.filter(pg=>pg.pedido_id===p.id);
        const cobrado = pagos.reduce((acc,pg)=>acc+Number(pg.abono||0),0);
        const total = calcTotalPedido(p);
        const pendiente = total - cobrado;

        const html = `
          <div class="item">
            <div class="row" style="justify-content:space-between">
              <div><strong>${p.articulo||"(Art√≠culo)"}</strong> <span class="muted">‚Ä¢ ${p.fecha||""}</span></div>
              <div class="pill">${(p.estado||"pendiente")}</div>
            </div>
            <div class="muted">Cliente: ${cli? (cli.nombre||"-") : "(desconocido)"} ‚Ä¢ Tracking: ${p.tracking||"-"}</div>
            <div class="row" style="gap:20px;margin-top:6px">
              <div><strong>Total:</strong> ${fmtMoney(total)}</div>
              <div><strong>Cobrado:</strong> ${fmtMoney(cobrado)}</div>
              <div><strong>Pendiente:</strong> ${fmtMoney(pendiente)}</div>
            </div>
            <div class="row" style="margin-top:8px">
              <input type="number" placeholder="Abono (RD$)" id="i_${p.id}" style="max-width:200px">
              <button class="btn ok" onclick="registrarAbono('${p.cliente_id}','${p.id}')">Registrar abono</button>
            </div>
          </div>
        `;
        box.insertAdjacentHTML("beforeend", html);
      });
    }

    function renderPagos(){
      const box = byId("listaPagos");
      box.innerHTML = "";
      const list = [...PAGOS].sort((a,b)=> (new Date(b.fecha||0)) - (new Date(a.fecha||0))).slice(0,20);
      list.forEach(pg=>{
        const cli = CLIENTES.find(c=>c.id===pg.cliente_id);
        const ped = PEDIDOS.find(p=>p.id===pg.pedido_id);
        const html = `
          <div class="item">
            <div class="row" style="justify-content:space-between">
              <div><strong>Abono:</strong> ${fmtMoney(pg.abono)}</div>
              <div class="muted">${pg.fecha||""}</div>
            </div>
            <div class="muted">Cliente: ${cli? (cli.nombre||"-"):"-"} ‚Ä¢ Pedido: ${ped? (ped.articulo||"-"):"-"}</div>
          </div>
        `;
        box.insertAdjacentHTML("beforeend", html);
      });
    }

    // ========= CALC =========
    function calcTotalPedido(p){
      const v = Number(p.valor||0), pr = Number(p.porc||0), lb = Number(p.libra||0);
      // si viene total ya calculado en la hoja, √∫salo; si no, calcula
      const tSheet = Number(p.total||0);
      const tCalc = v + (v * pr / 100) + lb;
      return tSheet>0 ? tSheet : tCalc;
    }

    // ========= CREATE =========
    byId("btnAddCliente").onclick = async ()=>{
      const nombre = byId("cNombre").value.trim();
      const telefono = byId("cTelefono").value.trim();
      const email = byId("cEmail").value.trim();
      const notas = byId("cNotas").value.trim();
      if(!nombre) return alert("Escribe el nombre del cliente");

      const row = {
        id: uid("cli"),
        tipo: "cliente",
        nombre, telefono, email, notas,
        fecha: new Date().toLocaleString("es-DO")
      };
      await apiInsert(row);
      byId("cNombre").value = byId("cTelefono").value = byId("cEmail").value = byId("cNotas").value = "";
      await loadAll(true);
    };

    byId("btnAddPedido").onclick = async ()=>{
      const cliente_id = byId("pCliente").value;
      if(!cliente_id) return alert("Elige un cliente");
      const articulo = byId("pArticulo").value.trim();
      const valor = Number(byId("pValor").value||0);
      const porc = Number(byId("pPorc").value||0);
      const libra = Number(byId("pLibra").value||0);
      const tracking = byId("pTracking").value.trim();
      const estado = byId("pEstado").value;

      const row = {
        id: uid("ped"),
        tipo: "pedido",
        cliente_id, articulo, valor, porc, libra,
        total: (valor + (valor*porc/100) + libra),
        tracking, estado,
        fecha: new Date().toLocaleString("es-DO")
      };
      await apiInsert(row);
      byId("pArticulo").value = byId("pValor").value = byId("pPorc").value = byId("pLibra").value = byId("pTracking").value = "";
      await loadAll(true);
    };

    byId("btnAddPago").onclick = async ()=>{
      const cliente_id = byId("payCliente").value;
      const pedido_id = byId("payPedido").value;
      const abono = Number(byId("payMonto").value||0);
      if(!cliente_id) return alert("Elige cliente");
      if(!pedido_id) return alert("Elige pedido");
      if(!(abono>0)) return alert("Ingresa un monto v√°lido");

      const row = {
        id: uid("pay"),
        tipo: "pago",
        cliente_id, pedido_id,
        abono,
        fecha: new Date().toLocaleString("es-DO")
      };
      await apiInsert(row);
      byId("payMonto").value = "";
      await loadAll(true);
    };

    // desde la lista de pedidos (input por fila)
    window.registrarAbono = async (cliente_id, pedido_id)=>{
      const input = byId(`i_${pedido_id}`);
      const abono = Number(input.value||0);
      if(!(abono>0)) return alert("Ingresa un monto v√°lido");
      const row = {
        id: uid("pay"),
        tipo: "pago",
        cliente_id, pedido_id,
        abono,
        fecha: new Date().toLocaleString("es-DO")
      };
      await apiInsert(row);
      input.value = "";
      await loadAll(false);
    };

    // ========= INIT =========
    loadAll(false);
  </script>
</body>
</html>


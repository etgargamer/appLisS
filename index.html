<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AppLisS - Control de Clientes y Pedidos</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #f8fafc;
      color: #0f172a;
      margin: 0;
      padding: 20px;
    }
    h1 { text-align: center; color: #1e293b; }
    .container { max-width: 900px; margin: 0 auto; }
    section {
      background: #fff;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    input, select {
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
    }
    button {
      background: #0f172a;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 14px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover { background: #1e293b; }
    .listado {
      margin-top: 15px;
      border-top: 1px solid #e2e8f0;
      padding-top: 10px;
    }
    .cliente-card, .pedido-card {
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      margin: 5px 0;
      background: #f1f5f9;
      cursor: pointer;
    }
    .cliente-card:hover { background: #e2e8f0; }
    .whatsapp-btn {
      background: #25d366;
      color: white;
      border: none;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      margin-top: 5px;
    }
    .whatsapp-btn:hover { background: #1ebe5c; }
    .pago-btn {
      background: #2563eb;
      color: white;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9em;
      margin-top: 4px;
      display: inline-block;
    }
    .pago-btn:hover { background: #1e40af; }
    .campo-pago {
      margin-top: 5px;
      display: none;
    }
    #detalleCliente { display: none; }
    canvas {
      max-width: 400px;
      margin: 15px auto;
      display: block;
    }
    .subtitulo {
      font-weight: bold;
      margin-top: 20px;
      color: #1e293b;
    }
    #historialPagos {
      margin-top: 20px;
      background: #f9fafb;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #e2e8f0;
    }
    #historialPagos h3 {
      margin-top: 0;
      color: #0f172a;
    }
    .pago-item {
      font-size: 0.95em;
      border-bottom: 1px solid #e5e7eb;
      padding: 5px 0;
    }
  </style>
</head>
<body>
  <h1>üìã AppLisS - Liss Variedades</h1>
  <div class="container">

    <!-- === PANEL PRINCIPAL === -->
    <section id="panelPrincipal">
      <h2>üë§ Registrar Cliente</h2>
      <input id="nombreCliente" placeholder="Nombre completo">
      <input id="telefonoCliente" placeholder="Tel√©fono (solo n√∫meros)">
      <input id="direccionCliente" placeholder="Direcci√≥n">
      <button id="btnAgregarCliente">Agregar Cliente</button>
      <div class="listado" id="listaClientes"></div>
    </section>

    <section id="panelPedidos">
      <h2>üì¶ Registrar Pedido</h2>
      <select id="clienteSelect"></select>
      <input id="articulo" placeholder="Art√≠culo">
      <input id="valorArticulo" type="number" placeholder="Valor del art√≠culo">
      <input id="porcentaje" type="number" placeholder="Porcentaje (%)">
      <input id="libra" type="number" placeholder="Costo por libra">
      <input id="pagado" type="number" placeholder="Monto pagado">
      <button id="btnAgregarPedido">Guardar Pedido</button>
      <div class="listado" id="listaPedidos"></div>
    </section>

    <!-- === DETALLE DEL CLIENTE === -->
    <section id="detalleCliente">
      <h2 id="tituloDetalle">üìÑ Detalle del Cliente</h2>
      <div id="infoCliente"></div>
      <div id="pedidosCliente"></div>
      <div id="resumenCliente" style="margin-top:10px;font-weight:600;"></div>
      <canvas id="graficaCliente"></canvas>

      <!-- === FORMULARIO NUEVO PEDIDO === -->
      <div class="subtitulo">‚ûï Agregar nuevo pedido</div>
      <input id="articuloCliente" placeholder="Art√≠culo">
      <input id="valorCliente" type="number" placeholder="Valor del art√≠culo">
      <input id="porcentajeCliente" type="number" placeholder="Porcentaje (%)">
      <input id="libraCliente" type="number" placeholder="Costo por libra">
      <input id="pagadoCliente" type="number" placeholder="Monto pagado">
      <button id="btnAgregarPedidoCliente">Guardar Pedido</button>

      <!-- === HISTORIAL DE PAGOS === -->
      <div id="historialPagos">
        <h3>üìú Historial de Pagos</h3>
        <div id="listaPagos"></div>
      </div>

      <button id="btnVolver">‚¨Ö Volver</button>
    </section>

  </div>

  <!-- === Chart.js CDN === -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- === FIREBASE SDK === -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, getDoc, doc, query, where, getDocs, updateDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDLKCGnKyr6iM0QuShBnfm sR9VgzStXlo",
      authDomain: "liss-variedades-cobranza.firebaseapp.com",
      projectId: "liss-variedades-cobranza",
      storageBucket: "liss-variedades-cobranza.appspot.com",
      messagingSenderId: "56696969375",
      appId: "1:56696969375:web:fcd9246988fb06ec97106a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const listaClientes = document.getElementById("listaClientes");
    const clienteSelect = document.getElementById("clienteSelect");
    const pedidosCliente = document.getElementById("pedidosCliente");
    const resumenCliente = document.getElementById("resumenCliente");
    const graficaCliente = document.getElementById("graficaCliente");
    const listaPagos = document.getElementById("listaPagos");
    const panelPrincipal = document.getElementById("panelPrincipal");
    const panelPedidos = document.getElementById("panelPedidos");
    const detalleCliente = document.getElementById("detalleCliente");
    const infoCliente = document.getElementById("infoCliente");
    const btnVolver = document.getElementById("btnVolver");
    const btnAgregarPedidoCliente = document.getElementById("btnAgregarPedidoCliente");

    const articuloCliente = document.getElementById("articuloCliente");
    const valorCliente = document.getElementById("valorCliente");
    const porcentajeCliente = document.getElementById("porcentajeCliente");
    const libraCliente = document.getElementById("libraCliente");
    const pagadoCliente = document.getElementById("pagadoCliente");

    let clienteActual = null;
    let grafico = null;

    // === LISTAR CLIENTES ===
    onSnapshot(collection(db, "clientes"), (snapshot) => {
      listaClientes.innerHTML = "";
      clienteSelect.innerHTML = "<option value=''>Selecciona un cliente</option>";
      snapshot.forEach((docSnap) => {
        const c = docSnap.data();
        listaClientes.innerHTML += `
          <div class="cliente-card" onclick="verCliente('${docSnap.id}')">
            <strong>${c.nombre}</strong><br>
            üìû ${c.telefono || "Sin tel√©fono"}<br>
            üìç ${c.direccion || "Sin direcci√≥n"}
          </div>
        `;
        clienteSelect.innerHTML += `<option value="${docSnap.id}">${c.nombre}</option>`;
      });
    });

    // === FUNCI√ìN PARA VER CLIENTE ===
    window.verCliente = async (clienteId) => {
      clienteActual = clienteId;
      const clienteSnap = await getDoc(doc(db, "clientes", clienteId));
      const c = clienteSnap.data();
      infoCliente.innerHTML = `
        <strong>${c.nombre}</strong><br>
        üìû ${c.telefono || "Sin tel√©fono"}<br>
        üìç ${c.direccion || "Sin direcci√≥n"}
      `;
      await actualizarPedidosCliente();
      await cargarHistorialPagos();
      panelPrincipal.style.display = "none";
      panelPedidos.style.display = "none";
      detalleCliente.style.display = "block";
    };

    // === ACTUALIZAR PEDIDOS ===
    async function actualizarPedidosCliente() {
      const q = query(collection(db, "pedidos"), where("clienteId", "==", clienteActual));
      const pedidosSnap = await getDocs(q);
      pedidosCliente.innerHTML = "";
      let total = 0, pagado = 0, pendiente = 0;

      const clienteSnap = await getDoc(doc(db, "clientes", clienteActual));
      const c = clienteSnap.data();

      pedidosSnap.forEach((pDoc) => {
        const p = pDoc.data();
        total += p.total;
        pagado += p.pagado;
        pendiente += p.pendiente;

        pedidosCliente.innerHTML += `
          <div class="pedido-card" id="pedido-${pDoc.id}">
            <strong>${p.articulo}</strong><br>
            üí∞ Total: RD$${p.total.toFixed(2)}<br>
            Pagado: RD$${p.pagado.toFixed(2)} | Pendiente: RD$${p.pendiente.toFixed(2)}<br>
            <button class="pago-btn" onclick="mostrarCampoPago('${pDoc.id}')">üíµ Registrar Pago</button>
            <div class="campo-pago" id="campo-${pDoc.id}">
              <input type="number" id="monto-${pDoc.id}" placeholder="Monto abonado">
              <button onclick="registrarPago('${pDoc.id}','${c.nombre}')">Guardar</button>
            </div>
          </div>
        `;
      });

      resumenCliente.innerHTML = `
        üí∞ Total general: RD$${total.toFixed(2)} |
        Pagado: RD$${pagado.toFixed(2)} |
        Pendiente: RD$${pendiente.toFixed(2)}
      `;

      if (grafico) grafico.destroy();
      grafico = new Chart(graficaCliente, {
        type: "doughnut",
        data: {
          labels: ["Pagado", "Pendiente"],
          datasets: [{ data: [pagado, pendiente], backgroundColor: ["#22c55e", "#f97316"] }]
        },
        options: { plugins: { title: { display: true, text: "Estado de Pagos" } } }
      });
    }

    // === MOSTRAR CAMPO DE PAGO ===
    window.mostrarCampoPago = (id) => {
      const campo = document.getElementById(`campo-${id}`);
      campo.style.display = campo.style.display === "block" ? "none" : "block";
    };

    // === REGISTRAR PAGO + HISTORIAL ===
    window.registrarPago = async (pedidoId, nombreCliente) => {
      const monto = parseFloat(document.getElementById(`monto-${pedidoId}`).value) || 0;
      if (monto <= 0) return alert("Ingresa un monto v√°lido.");

      const pedidoRef = doc(db, "pedidos", pedidoId);
      const pedidoSnap = await getDoc(pedidoRef);
      const p = pedidoSnap.data();

      const nuevoPagado = p.pagado + monto;
      const nuevoPendiente = p.total - nuevoPagado;

      await updateDoc(pedidoRef, { pagado: nuevoPagado, pendiente: nuevoPendiente });

      // === Guardar en colecci√≥n /pagos ===
      await addDoc(collection(db, "pagos"), {
        clienteId: clienteActual,
        clienteNombre: nombreCliente,
        pedidoId,
        articulo: p.articulo,
        monto,
        fecha: serverTimestamp()
      });

      alert("‚úÖ Pago registrado correctamente");
      await actualizarPedidosCliente();
      await cargarHistorialPagos();
    };

    // === CARGAR HISTORIAL DE PAGOS ===
    async function cargarHistorialPagos() {
      const q = query(collection(db, "pagos"), where("clienteId", "==", clienteActual), orderBy("fecha", "desc"));
      const pagosSnap = await getDocs(q);
      listaPagos.innerHTML = "";

      pagosSnap.forEach((pgDoc) => {
        const pago = pgDoc.data();
        const fecha = pago.fecha?.toDate().toLocaleString("es-DO") || "(fecha desconocida)";
        listaPagos.innerHTML += `
          <div class="pago-item">
            üíµ ${pago.articulo} - RD$${pago.monto.toFixed(2)}<br>
            üìÖ ${fecha}
          </div>
        `;
      });

      if (!pagosSnap.size) listaPagos.innerHTML = "<em>No hay pagos registrados</em>";
    }

    // === VOLVER AL PANEL PRINCIPAL ===
    btnVolver.onclick = () => {
      detalleCliente.style.display = "none";
      panelPrincipal.style.display = "block";
      panelPedidos.style.display = "block";
      clienteActual = null;
    };
  </script>
</body>
</html>

